---
import Section from "@/components/ui/Section.astro";
import SectionTitle from "@/components/ui/SectionTitle.astro";
import Button from "@/components/ui/Button.astro";
import MapPreview from "@/components/ui/MapPreview.astro";
import { site } from "@/lib/content";
import { withBase } from "@/lib/urls";

function getTrackEvent(
  href: string,
): "click_whatsapp" | "click_maps" | "click_call" | undefined {
  const normalized = href.toLowerCase();
  if (normalized.includes("wa.me") || normalized.includes("whatsapp")) {
    return "click_whatsapp";
  }
  if (normalized.startsWith("tel:")) {
    return "click_call";
  }
  if (
    normalized.includes("google.com/maps") ||
    normalized.includes("maps.google.com")
  ) {
    return "click_maps";
  }

  return undefined;
}

const mapsAction =
  site.locationHours.actions.find(
    (action) => getTrackEvent(action.href) === "click_maps",
  ) ?? {
    label: "Abrir en Google Maps",
    href: site.contact.googleMapsUrl ?? site.contact.mapsUrl,
    variant: "secondary" as const,
  };

const mapPreviewSrc = withBase("/images/mapa.png");
---

<Section id="ubicacion" variant="loose" className="bg-muted py-14 md:py-20">
  <div class="grid gap-4 md:gap-6 lg:grid-cols-2">
    <div>
      <SectionTitle
        title={site.locationHours.title}
        subtitle={site.locationHours.subtitle}
      />
      <div class="mt-6 space-y-3 md:mt-8">
        <p
          class="rounded-xl border border-border/40 bg-surface px-4 py-3 text-secondary text-text-muted"
        >
          {site.contact.addressLine}
        </p>
        <p
          class="rounded-xl border border-border/40 bg-surface px-4 py-3 text-secondary text-text-muted"
        >
          {site.contact.city}, {site.contact.state}
        </p>
        <p
          class="rounded-xl border border-border/40 bg-surface px-4 py-3 text-secondary text-text-muted"
        >
          {site.hours.daysLabel} &middot; {site.hours.timeLabel}
        </p>
      </div>
      <div class="mt-8 flex flex-wrap gap-3">
        {
          site.locationHours.actions.map((action) => (
            <Button
              href={action.href}
              variant={action.variant}
              ariaLabel={action.label}
              trackEvent={getTrackEvent(action.href)}
              trackSource="location"
            >
              {action.label}
            </Button>
          ))
        }
      </div>
    </div>

    <MapPreview
      mapsUrl={mapsAction.href}
      staticMapUrl={mapPreviewSrc}
      alt={`Mapa del consultorio en ${site.contact.addressLine}, ${site.contact.city}, ${site.contact.state}`}
    />
  </div>
</Section>
