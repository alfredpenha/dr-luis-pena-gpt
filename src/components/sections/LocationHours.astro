---
import Container from "@/components/ui/Container.astro";
import SectionTitle from "@/components/ui/SectionTitle.astro";
import Button from "@/components/ui/Button.astro";
import MapPreview from "@/components/ui/MapPreview.astro";
import { site } from "@/lib/content";
import { getGoogleStaticMapUrl } from "@/lib/maps";

function getTrackEvent(
  href: string,
): "click_whatsapp" | "click_maps" | "click_call" | undefined {
  const normalized = href.toLowerCase();
  if (normalized.includes("wa.me") || normalized.includes("whatsapp")) {
    return "click_whatsapp";
  }
  if (normalized.startsWith("tel:")) {
    return "click_call";
  }
  if (
    normalized.includes("google.com/maps") ||
    normalized.includes("maps.google.com")
  ) {
    return "click_maps";
  }

  return undefined;
}

const mapsAction =
  site.locationHours.actions.find(
    (action) => getTrackEvent(action.href) === "click_maps",
  ) ?? {
    label: "Abrir en Google Maps",
    href: site.contact.googleMapsUrl ?? site.contact.mapsUrl,
    variant: "secondary" as const,
  };

const staticMapUrl =
  site.maps.provider === "google" && site.maps.static.enabled
    ? getGoogleStaticMapUrl(site.maps.static)
    : null;
---

<section id="ubicacion" class="bg-surface-elevated py-14 sm:py-20">
  <Container>
    <div class="grid gap-8 lg:grid-cols-2">
      <div>
        <SectionTitle
          title={site.locationHours.title}
          subtitle={site.locationHours.subtitle}
        />
        <div class="mt-6 space-y-3">
          <p
            class="rounded-lg border border-border bg-muted px-4 py-3 text-secondary text-text-muted"
          >
            {site.contact.addressLine}
          </p>
          <p
            class="rounded-lg border border-border bg-muted px-4 py-3 text-secondary text-text-muted"
          >
            {site.contact.city}, {site.contact.state}
          </p>
          <p
            class="rounded-lg border border-border bg-muted px-4 py-3 text-secondary text-text-muted"
          >
            {site.hours.daysLabel} &middot; {site.hours.timeLabel}
          </p>
        </div>
        <div class="mt-6 flex flex-wrap gap-3">
          {
            site.locationHours.actions.map((action) => (
              <Button
                href={action.href}
                variant={action.variant}
                ariaLabel={action.label}
                trackEvent={getTrackEvent(action.href)}
                trackSource="location"
              >
                {action.label}
              </Button>
            ))
          }
        </div>
      </div>

      <MapPreview
        mapsUrl={mapsAction.href}
        staticMapUrl={staticMapUrl}
        alt={`Mapa del consultorio en ${site.contact.addressLine}, ${site.contact.city}, ${site.contact.state}`}
      />
    </div>
  </Container>
</section>
